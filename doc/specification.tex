%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 
% = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
%

\documentclass[]{article}

\usepackage[english]{babel}
\usepackage[utf8]{inputenc}
\usepackage[margin=1.5in,letterpaper]{geometry}
\usepackage{amsmath}
\usepackage{graphicx}
\usepackage[colorinlistoftodos]{todonotes}

% for linking table of content with specific page number
\usepackage{hyperref}
\hypersetup{
    colorlinks=true, 
    linktoc=all,
    linkcolor=black,
}

% for inserting code
\usepackage{listings}
\definecolor{j_dkgreen}{rgb}{0,0.6,0}
\definecolor{j_gray}{rgb}{0.5,0.5,0.5}
\definecolor{j_mauve}{rgb}{0.58,0,0.82}
\lstset{
  frame=tb,
  language=Java,
  aboveskip=3mm,
  belowskip=3mm,
  showstringspaces=false,
  columns=flexible,
  basicstyle={\small\ttfamily},
  numbers=none,
  numberstyle=\tiny\color{j_gray},
  keywordstyle=\color{blue},
  commentstyle=\color{j_dkgreen},
  stringstyle=\color{j_mauve},
  breaklines=true,
  breakatwhitespace=true,
  tabsize=4
}

\begin{document}

%
% = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 
% = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

\title{Java Typestate Checking Implementation Notes}
\author{Xueying Qin}
\date{\small\today}

\maketitle

% = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%------------------------------------------------------------------------------------------------------------
%------------------------------------------------------------------------------------------------------------
\section{Structure of ExtendJ}
%------------------------------------------------------------------------------------------------------------
%------------------------------------------------------------------------------------------------------------
\subsection{General Information}
Information of ExtendJ, which is the extendable Java compiler we used for this project, can be found at \url{https://extendj.org}. \\[0.2cm]
API documentation can be found at \url{https://extendj.org/doc/}.\\[0.2cm]
ExtendJ syntax reference can be found at \url{http://jastadd.org/web/documentation/reference-manual.php#jadd}.

\subsection{ExtendJ Problem-Reporting Features}
ExtendJ uses bottom-up problem reporting design. \\[0.2cm]
When the method \texttt{processingCompilationUnit()} is called, all \texttt{ASTNode}s in the Java abstact syntax tree (AST) contribute problems (including warnings and errors) such as type problems, name problems etc. to \texttt{CompilationUnit}. The order of problem reporting is according to node's position in source code. Root of Java AST, which is \texttt{Program}, processes each \texttt{CompilationUnit} to check whether there are problems need to be reported or not.

%------------------------------------------------------------------------------------------------------------
%------------------------------------------------------------------------------------------------------------
\section{Previous Version of Mungo}
%------------------------------------------------------------------------------------------------------------
%------------------------------------------------------------------------------------------------------------
\subsection{General Information}
Project website: \url{http://www.dcs.gla.ac.uk/research/mungo/index.html}. \\[0.2cm]
More information can be found at \url{https://bitbucket.org/abcd-glasgow/mungo}. \\[0.2cm]
Source code of previous version Mungo can be found at \url{https://github.com/Dimitris-Kouzapas/javatypestate}.

\subsection{Code Reuse}
In current version, the grammar and parser for typestate protocol files are adapted with modification from previous version. The algorithm of typestate protocol sematic checking is also from previous version but implemented using ExtendJ bottom-up problem reporting design. Moreover, helper methods for typestate \texttt{ASTNode} are adapted from previous version.

\subsection{Changes in Protocol Specification}
If a \texttt{TypestateMethod}'s parameters that have a class type with typestate specification, its state need to be explicitly stated in protocol file. The sytax is \texttt{Class<<State>>}. \\[0.2cm]
Similarly, If the return type has typestate specification, its state also need to be specified.

\subsection{Changes in Execution Command}
Different from previous version, class path do not need to be included in command for parsing protocol. \\[0.2cm]
Format of command to run current version:
\begin{verbatim}
java -jar Typestate.jar [filepath]
\end{verbatim}
The \texttt{[filepath]} is the same as \texttt{[filepath]} in Java compiler, which should include all relevant Java source files.\\[0.2cm]
Here is an example command:
\begin{verbatim}
java -jar Typestate.jar testfiles/collection/*.java
\end{verbatim}

%------------------------------------------------------------------------------------------------------------
%------------------------------------------------------------------------------------------------------------
\section{Typestate Annotation Detecting and Typestate Protocol File Parsing}
%------------------------------------------------------------------------------------------------------------
%------------------------------------------------------------------------------------------------------------
\subsection{Typestate Annotation Detecting}
After Java source code parsed into AST, similar to collecting problems, the special typestate annotations are reported to \texttt{Program} by nodes in AST. If there are detected typestate annotations, before processing Java syntax checking, protocol files need to be located, parsed and varified.

\subsection{Typestate Protocol File Parsing}
A typestate protocol file contains only one Java class typestate declaration. It will be parsed into a \texttt{CompilationUnit} and added to \texttt{Program}. Then a semantic checking on the protocol AST will be performed. Semantic errors of protocol files will also be reported. Only if all the protocol files pass semantic checking, Java source files will be checked. \\[0.2cm]
Notice that a protocol file is parsed as a part of the Java AST. If a traversal from \texttt{Program} is performed, all nodes in the subtree parsed from the protocol file will be visited.

%------------------------------------------------------------------------------------------------------------
%------------------------------------------------------------------------------------------------------------
\section{Storing and Updating Typestate Information}
%------------------------------------------------------------------------------------------------------------
%------------------------------------------------------------------------------------------------------------
In current design, typestate information is stored in two formats. In an \texttt{ASTNode} with typestate specifcation, typestate information is stored as a field. In each \texttt{ClassDecl}, there will be a \texttt{SymbolTable} storing global and local variables' typestates.\\[0.2cm]
The original idea was to only store typestate in field, however this design caused difficulties in nested switch statement checking. Using a \texttt{SymbolTable} to store typestate information is a good solution to this issue.\\[0.2cm]
Although using \texttt{SymbolTable} could handle variable typestate checking and updating, storing information in \texttt{ASTNode} is still necessary in current design. Since some \texttt{ASTNode} with typestate cannot be stored in the \texttt{SymbolTable}. For instance, the return typestate of a \texttt{MethodDecl}, the typestate of a \texttt{Dot} and so on. \\[0.2cm]
Update of typestate state is done during typestate checking, i.e., problems reporting. Although it is not a good design to perform typestate checking and state updating at the same time, it is the best way to implement this type checking under ExtendJ framework.

%------------------------------------------------------------------------------------------------------------
%------------------------------------------------------------------------------------------------------------
\section{Typestate Checking}
%------------------------------------------------------------------------------------------------------------
%------------------------------------------------------------------------------------------------------------

\subsection{Depth-First Search Traversing Typestate AST for Collecting Problems}
Using the ExtendJ problems reporting design makes typestate checking slightly complex. As we discussed in several meetings, the Visitor Pattern is more suitable for typestate checking. \\[0.2cm]
However, it is still possible to make some modification to this framework. One of the major modification is that instead of reporting problems according to the order of position in source code, performing typestate checking according to Depth-first search (DFS) traversal order is implemented. \\[0.2cm]
The reason of forcing typestate checking into this order is that typestate consistency checking of field declarators within method declarations requires method declarations are checked according to correct transition order specified in protocol files. \\[0.2cm]
Base on this modification, in current design, problems are collected by each \texttt{MethodDecl}. \texttt{MethodDecl}s report problems to the \texttt{CompilationUnit} according to the DFS traversal order in typestate protocol AST. 

\subsection{Switch-Case Statements Typestate Checking}
There are some restrictions in switch statements for typestate checking:
\begin{enumerate}
	\item Case labels must match the labels in \texttt{TypestateSwitch} and \texttt{default} case is not allowed.
	\item There must be a break or continue statement at the end of a case.
	\item All variables must have same typestate at break statemets with same target label. Same for continue statements.
\end{enumerate}
The typestate checking process works as this:
\begin{enumerate}
	\item A \texttt{SwitchStmt} will push a new local symbol table on the local symbol stack.
	\item All statements in the \texttt{SwitchStmt} will be labelled. Problem will be reported for invalid cases (violating above restrictions). The last break or continue statement will be labelled for consistency checking.
	\item Each \texttt{ConstCase} will push a new local symbol tabel on the local symbol stack.
	\item Each \texttt{BreakStmt} or \texttt{ContinueStmt} will pop a symbol table from the local symbol table stack and store it in a field.
	\item The last break or continue statement will check whether all variables have same typestate at break statemets with same target label at the end of \texttt{SwitchStmt} and report problems.
\end{enumerate}

\subsection{Loop Typstate Checking}
The loop for typestate checking will always be a do-while loop controlled by break and continue statements. For example:
\begin{lstlisting}
loop: do {
			Node n = s.get();
			switch(s.isEmpty()) {
				case TRUE:
					break loop;

				case FALSE:
					continue loop;
			}
		} while(true);
\end{lstlisting}
The typestate checking on loop is similiar to checking swiich statements. Variables at break/continue statements with same target labels should at same state. Moreover, at \texttt{conitinue loop}, variables should be in the same state as the beginning of this loop.





%------------------------------------------------------------------------------------------------------------
%------------------------------------------------------------------------------------------------------------
\section{Existing Issues}
%------------------------------------------------------------------------------------------------------------
%------------------------------------------------------------------------------------------------------------
\subsection{If-Else Statements Typestate Checking}


%
% = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\end{document}